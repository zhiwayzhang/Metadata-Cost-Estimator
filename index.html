<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Metadata-Cost-Estimator</title>
  <style>
    :root {
      --bg: #0b0c10;
      --panel: #121319;
      --muted: #9aa3af;
      --text: #e5e7eb;
      --accent: #6ee7b7;
      --danger: #f87171;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 32px; 
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      font-size: 16px;
      color: var(--text); 
      background: radial-gradient(1200px 600px at 10% -10%, #1a1b26 0%, var(--bg) 45%);
    }
    h1 { font-size: 32px; margin: 0 0 20px; letter-spacing: .3px; }
    h2 { font-size: 22px; margin: 24px 0 16px; letter-spacing: .2px; }
    p { margin: 0 0 16px; color: var(--muted); font-size: 16px; line-height: 1.6; }
    .wrap { max-width: 1100px; margin: 0 auto; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent 20%), var(--panel);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 32px; margin-top: 20px;
    }
    .grid {
      display: grid; gap: 20px; grid-template-columns: repeat(12, 1fr);
    }
    .field { grid-column: span 12; }
    @media (min-width: 720px){ .field.h6 { grid-column: span 6; } }
    label { display: block; font-size: 15px; margin-bottom: 8px; color: var(--muted); font-weight: 500; }
    .row { display: flex; gap: 12px; align-items: center; }
    input[type="number"], input[type="text"], select {
      width: 100%; padding: 14px 16px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03); color: var(--text);
      outline: none; transition: border-color .15s ease;
      font-size: 16px;
    }
    input::placeholder { color: #808a99; }
    input[type="number"]:focus, input[type="text"]:focus, select:focus {
      border-color: rgba(110,231,183,.6);
    }
    .actions { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px; }
    button {
      border: 0; padding: 14px 20px; border-radius: 12px; cursor: pointer; font-weight: 600;
      background: rgba(110,231,183,.12); color: var(--accent);
      outline: none; box-shadow: inset 0 0 0 1px rgba(110,231,183,.35);
      transition: transform .04s ease, box-shadow .15s ease, filter .15s ease;
      font-size: 15px;
    }
    button:hover { filter: brightness(1.05); }
    button:active { transform: translateY(1px); }
    .btn-secondary {
      background: rgba(255,255,255,.06); color: #d1d5db; box-shadow: inset 0 0 0 1px rgba(255,255,255,.14);
    }
    .btn-danger {
      background: rgba(248,113,113,.12); color: var(--danger); box-shadow: inset 0 0 0 1px rgba(248,113,113,.35);
    }
    .note { font-size: 14px; color: var(--muted); margin-top: 8px; line-height: 1.5; }
    .result {
      margin-top: 20px; padding: 20px; border-radius: 12px;
      background: rgba(110,231,183,.06); border: 1px dashed rgba(110,231,183,.35);
      display: none;
    }
    .error { color: var(--danger); font-size: 15px; margin-top: 12px; display: none; }
    .muted { color: var(--muted); }
    code.inline { padding: 3px 8px; background: rgba(255,255,255,.06); border-radius: 6px; font-size: 14px; }
    footer { margin-top: 32px; font-size: 14px; color: var(--muted); line-height: 1.6; }
    
    .config-list {
      margin-top: 16px;
      display: none;
    }
    .config-item {
      padding: 14px 16px;
      margin-bottom: 10px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .config-info {
      flex: 1;
    }
    .config-name {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }
    .config-meta {
      font-size: 13px;
      color: var(--muted);
    }
    .config-actions {
      display: flex;
      gap: 8px;
    }
    .config-actions button {
      padding: 8px 14px;
      font-size: 13px;
    }
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }
    .result-box {
      padding: 16px;
      background: rgba(255,255,255,.03);
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.08);
    }
    .result-label {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .result-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Metadata-Cost-Estimator</h1>
    <p>给定设备容量、Sector 大小、以及每 Sector 的元数据开销，计算系统整体元数据开销。使用 IEC 单位 (KiB/MiB/GiB/TiB)。</p>

    <div class="card">
      <div class="grid">
        <div class="field h6">
          <label>设备容量</label>
          <div class="row">
            <input id="capacityValue" type="number" inputmode="decimal" step="any" min="0" placeholder="例如 1 或 0.5" value="1" />
            <select id="capacityUnit" aria-label="容量单位">
              <option value="GiB" selected>GiB</option>
              <option value="TiB">TiB</option>
            </select>
          </div>
          <div class="note">支持 GiB / TiB。</div>
        </div>

        <div class="field h6">
          <label>Sector（设备管理粒度）大小</label>
          <div class="row">
            <input id="sectorValue" type="number" inputmode="decimal" step="any" min="1" placeholder="例如 4096 或 512" value="4" />
            <select id="sectorUnit" aria-label="Sector 单位">
              <option value="Bytes">Bytes</option>
              <option value="KiB" selected>KiB</option>
            </select>
          </div>
          <div class="note">常见值：512 B、4 KiB 等。</div>
        </div>

        <div class="field h6">
          <label>每 Sector 的元数据大小</label>
          <div class="row">
            <input id="metaPerSectorValue" type="number" inputmode="decimal" step="any" min="0" placeholder="例如 64 或 4" value="4" />
            <select id="metaPerSectorUnit" aria-label="元数据单位">
              <option value="bits">bits</option>
              <option value="KiB" selected>KiB</option>
            </select>
          </div>
          <div class="note">支持 KiB 或 bits（例如位图 1 bit/sector；输入 1）。</div>
        </div>

        <div class="field h6">
          <label>配置名称（保存用，可选）</label>
          <input id="configName" type="text" placeholder="例如：高密度存储配置" value="" />
          <div class="note">保存时会将当前输入保存到浏览器 Local Storage，支持保存多个配置。</div>
        </div>
      </div>

      <div class="actions">
        <button id="calcBtn">计算元数据开销</button>
        <button id="saveBtn" class="btn-secondary">保存配置</button>
        <button id="toggleListBtn" class="btn-secondary">查看已保存配置</button>
      </div>

      <div id="error" class="error"></div>

      <div id="result" class="result">
        <div style="font-weight:700; font-size:20px; margin-bottom:16px;">元数据总开销</div>
        <div class="result-grid">
          <div class="result-box">
            <div class="result-label">GiB 表示</div>
            <div class="result-value" id="resultGiB">-</div>
          </div>
          <div class="result-box">
            <div class="result-label">MiB 表示</div>
            <div class="result-value" id="resultMiB">-</div>
          </div>
        </div>
        <div id="detailsOut" class="muted" style="font-size:14px; margin-top:16px; line-height:1.8;"></div>
      </div>

      <div id="configList" class="config-list">
        <h2>已保存的配置</h2>
        <div id="configListContent"></div>
      </div>
    </div>

    <footer>
      <div>单位换算：1 KiB = 1024 B，1 MiB = 1024 KiB，1 GiB = 1024 MiB，1 TiB = 1024 GiB。</div>
      <div class="note">当容量不是 Sector 大小整数倍时，计算按可容纳的整型 Sector 数量（向下取整）。</div>
    </footer>
  </div>

  <script>
    (function(){
      const KiB = 1024;
      const MiB = KiB * 1024;       // 1,048,576
      const GiB = MiB * 1024;       // 1,073,741,824
      const TiB = GiB * 1024;       // 1,099,511,627,776

      const $ = (id) => document.getElementById(id);

      const els = {
        capacityValue: $("capacityValue"),
        capacityUnit: $("capacityUnit"),
        sectorValue: $("sectorValue"),
        sectorUnit: $("sectorUnit"),
        metaValue: $("metaPerSectorValue"),
        metaUnit: $("metaPerSectorUnit"),
        configName: $("configName"),
        calcBtn: $("calcBtn"),
        saveBtn: $("saveBtn"),
        toggleListBtn: $("toggleListBtn"),
        error: $("error"),
        result: $("result"),
        resultGiB: $("resultGiB"),
        resultMiB: $("resultMiB"),
        detailsOut: $("detailsOut"),
        configList: $("configList"),
        configListContent: $("configListContent"),
      };

      function parseNum(v){
        const n = Number(v);
        return Number.isFinite(n) ? n : NaN;
      }

      function toBytesCapacity(value, unit){
        switch(unit){
          case 'GiB': return value * GiB;
          case 'TiB': return value * TiB;
          default: return NaN;
        }
      }

      function toBytesSector(value, unit){
        switch(unit){
          case 'Bytes': return value;
          case 'KiB': return value * KiB;
          default: return NaN;
        }
      }

      function formatDecimal(x, decimals = 2){
        const s = (Math.round(x * Math.pow(10, decimals)) / Math.pow(10, decimals)).toFixed(decimals);
        return s.replace(/\.?0+$/, '');
      }

      function calc(){
        els.error.style.display = 'none';
        els.result.style.display = 'none';

        const capVal = parseNum(els.capacityValue.value);
        const capUnit = els.capacityUnit.value;
        const secVal = parseNum(els.sectorValue.value);
        const secUnit = els.sectorUnit.value;
        const metaVal = parseNum(els.metaValue.value);
        const metaUnit = els.metaUnit.value;

        // 基础校验
        if ([capVal, secVal, metaVal].some(n => !Number.isFinite(n))){
          return showError('请输入有效的数字。');
        }
        if (capVal <= 0) return showError('设备容量必须大于 0');
        if (secVal <= 0) return showError('Sector 大小必须大于 0');
        if (metaVal < 0) return showError('每 Sector 元数据大小不能为负');

        const capacityBytes = toBytesCapacity(capVal, capUnit);
        const sectorBytes = toBytesSector(secVal, secUnit);
        if (!Number.isFinite(capacityBytes) || !Number.isFinite(sectorBytes)){
          return showError('单位选择有误。');
        }
        if (sectorBytes === 0) return showError('Sector 大小不能为 0');

        // 可容纳的整型 sector 数
        const sectors = Math.floor(capacityBytes / sectorBytes);
        if (sectors <= 0){
          return showError('容量小于一个 Sector，无法计算。');
        }

        let totalBytes = 0;
        if (metaUnit === 'KiB'){
          const bytesPerSector = metaVal * KiB;
          totalBytes = sectors * bytesPerSector;
        } else if (metaUnit === 'bits'){
          // 先总 bit，再整体向上取整到字节 (ceil(bits/8))
          const totalBits = sectors * metaVal;
          totalBytes = Math.ceil(totalBits / 8);
        } else {
          return showError('未知的元数据单位');
        }

        // 显示结果：分别以 GiB 和 MiB 显示
        const gib = totalBytes / GiB;
        const mib = totalBytes / MiB;
        
        els.resultGiB.textContent = `${formatDecimal(gib, 4)} GiB`;
        els.resultMiB.textContent = `${formatDecimal(mib, 2)} MiB`;

        // 附加明细
        const lines = [];
        lines.push(`可容纳的 Sector 数：<code class="inline">${sectors.toLocaleString('en-US')}</code>`);
        lines.push(`设备容量：<code class="inline">${capVal} ${capUnit}</code>`);
        lines.push(`Sector 大小：<code class="inline">${secVal} ${secUnit}</code>`);
        lines.push(`每 Sector 元数据：<code class="inline">${metaVal} ${metaUnit}</code>`);

        // 显示百分比（元数据 / 容量），仅作参考（以字节为基准）
        const pct = (totalBytes / capacityBytes) * 100;
        lines.push(`相对设备容量占比：<code class="inline">${formatDecimal(pct, 2)}%</code>`);

        els.detailsOut.innerHTML = lines.join('<br>');

        els.result.style.display = 'block';
      }

      function showError(msg){
        els.error.textContent = msg;
        els.error.style.display = 'block';
      }

      function save(){
        const name = (els.configName.value || `配置_${Date.now()}`).trim();
        if (!name){
          return showError('配置名称不能为空');
        }
        
        const payload = {
          capacityValue: els.capacityValue.value,
          capacityUnit: els.capacityUnit.value,
          sectorValue: els.sectorValue.value,
          sectorUnit: els.sectorUnit.value,
          metaPerSectorValue: els.metaValue.value,
          metaPerSectorUnit: els.metaUnit.value,
          savedAt: new Date().toISOString(),
        };
        
        try {
          // 获取所有配置
          const configs = getAllConfigs();
          configs[name] = payload;
          localStorage.setItem('mce:configs', JSON.stringify(configs));
          
          // 清空输入框
          els.configName.value = '';
          
          els.error.style.display = 'none';
          els.result.style.display = 'block';
          els.resultGiB.textContent = '✓';
          els.resultMiB.textContent = '保存成功';
          els.detailsOut.innerHTML = `<span class="muted">配置 "${name}" 已保存到本地（Local Storage）</span>`;
          
          // 如果配置列表正在显示，刷新它
          if (els.configList.style.display !== 'none') {
            renderConfigList();
          }
        } catch (e){
          showError('保存失败：浏览器可能禁用了本地存储或空间不足。');
        }
      }

      function getAllConfigs(){
        try {
          const data = localStorage.getItem('mce:configs');
          return data ? JSON.parse(data) : {};
        } catch (e){
          return {};
        }
      }

      function loadConfig(name){
        const configs = getAllConfigs();
        const config = configs[name];
        if (!config) return;

        els.capacityValue.value = config.capacityValue || '';
        els.capacityUnit.value = config.capacityUnit || 'GiB';
        els.sectorValue.value = config.sectorValue || '';
        els.sectorUnit.value = config.sectorUnit || 'KiB';
        els.metaValue.value = config.metaPerSectorValue || '';
        els.metaUnit.value = config.metaPerSectorUnit || 'KiB';
        
        els.error.style.display = 'none';
        els.result.style.display = 'block';
        els.resultGiB.textContent = '✓';
        els.resultMiB.textContent = '加载成功';
        els.detailsOut.innerHTML = `<span class="muted">已加载配置 "${name}"</span>`;
      }

      function deleteConfig(name){
        if (!confirm(`确定要删除配置 "${name}" 吗？`)) return;
        
        const configs = getAllConfigs();
        delete configs[name];
        localStorage.setItem('mce:configs', JSON.stringify(configs));
        renderConfigList();
      }

      function renderConfigList(){
        const configs = getAllConfigs();
        const names = Object.keys(configs);
        
        if (names.length === 0){
          els.configListContent.innerHTML = '<p class="muted">暂无保存的配置</p>';
          return;
        }

        const html = names.map(name => {
          const cfg = configs[name];
          const date = new Date(cfg.savedAt).toLocaleString('zh-CN');
          return `
            <div class="config-item">
              <div class="config-info">
                <div class="config-name">${escapeHtml(name)}</div>
                <div class="config-meta">
                  容量: ${cfg.capacityValue} ${cfg.capacityUnit} · 
                  Sector: ${cfg.sectorValue} ${cfg.sectorUnit} · 
                  元数据: ${cfg.metaPerSectorValue} ${cfg.metaPerSectorUnit}
                  <br>保存于: ${date}
                </div>
              </div>
              <div class="config-actions">
                <button class="btn-secondary" onclick="window.mceLoadConfig('${escapeHtml(name)}')">加载</button>
                <button class="btn-danger" onclick="window.mceDeleteConfig('${escapeHtml(name)}')">删除</button>
              </div>
            </div>
          `;
        }).join('');
        
        els.configListContent.innerHTML = html;
      }

      function toggleConfigList(){
        if (els.configList.style.display === 'none' || !els.configList.style.display){
          els.configList.style.display = 'block';
          renderConfigList();
          els.toggleListBtn.textContent = '隐藏已保存配置';
        } else {
          els.configList.style.display = 'none';
          els.toggleListBtn.textContent = '查看已保存配置';
        }
      }

      function escapeHtml(text){
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // 绑定事件
      els.calcBtn.addEventListener('click', calc);
      els.saveBtn.addEventListener('click', save);
      els.toggleListBtn.addEventListener('click', toggleConfigList);

      // 暴露全局函数供内联事件使用
      window.mceLoadConfig = loadConfig;
      window.mceDeleteConfig = deleteConfig;

      // 回车快速计算
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && (document.activeElement.tagName === 'INPUT')){
          calc();
        }
      });
    })();
  </script>
</body>
</html>